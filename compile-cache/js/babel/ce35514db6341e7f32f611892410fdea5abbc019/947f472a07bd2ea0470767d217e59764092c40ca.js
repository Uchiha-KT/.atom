'use babel';

var __hasProp = ({}).hasOwnProperty,
    __extends = function __extends(child, parent) {
  for (var key in parent) {
    if (__hasProp.call(parent, key)) child[key] = parent[key];
  }function ctor() {
    this.constructor = child;
  }ctor.prototype = parent.prototype;child.prototype = new ctor();child.__super__ = parent.prototype;return child;
},
    path = require('path'),
    File = require('./file'),
    Model = require('theorist').Model,
    multipleHostsEnabled = require('./helpers').multipleHostsEnabled;

module.exports = Directory = (function (parent) {
  __extends(Directory, parent);

  Directory.properties({
    parent: null,
    name: '',
    path: '',
    client: null,
    isExpanded: false,
    status: 0,
    folders: [],
    files: []
  });

  Directory.prototype.accessor('isRoot', function () {
    return this.parent === null;
  });

  Directory.prototype.accessor('local', function () {
    if (this.parent) return path.normalize(path.join(this.parent.local, this.name)).replace(/\\/g, '/');

    return multipleHostsEnabled() === true ? this.client.projectPath : atom.project.getPaths()[0];
  });

  Directory.prototype.accessor('remote', function () {
    if (this.parent) {
      return path.normalize(path.join(this.parent.remote, this.name)).replace(/\\/g, '/');
    }
    return this.path;
  });

  Directory.prototype.accessor('root', function () {
    if (this.parent) {
      return this.parent.root;
    }
    return this;
  });

  function Directory() {
    Directory.__super__.constructor.apply(this, arguments);
  }

  Directory.prototype.destroy = function () {
    this.folders.forEach(function (folder) {
      folder.destroy();
    });
    this.folders = [];

    this.files.forEach(function (file) {
      file.destroy();
    });
    this.files = [];

    if (!this.isRoot) {
      Directory.__super__.destroy.apply(this, arguments);
    }
  };

  Directory.prototype.sort = function () {
    this.folders.sort(function (a, b) {
      if (a.name == b.name) {
        return 0;
      }
      return a.name > b.name ? 1 : -1;
    });

    this.files.sort(function (a, b) {
      if (a.name == b.name) {
        return 0;
      }
      return a.name > b.name ? 1 : -1;
    });
  };

  Directory.prototype.exists = function (name, isdir) {
    if (isdir) {
      for (a = 0, b = this.folders.length; a < b; ++a) {
        if (this.folders[a].name == name) {
          return a;
        }
      }
    } else {
      for (a = 0, b = this.files.length; a < b; ++a) {
        if (this.files[a].name == name) {
          return a;
        }
      }
    }
    return null;
  };

  Directory.prototype.open = function (recursive, complete) {
    var self = this,
        client = self.root.client;

    client.list(self.remote, false, function (err, list) {
      if (err) {
        atom.notifications.addError('Remote FTP: ' + err, {
          dismissable: false
        });
        return;
      }

      self.status = 1;

      var folders = [],
          files = [];

      list.forEach(function (item) {
        var index = undefined,
            name = path.basename(item.name),
            entry = undefined;
        if (item.type == 'd' || item.type == 'l') {
          if (name == '.' || name == '..') {
            return;
          }
          if ((index = self.exists(name, true)) === null) {
            entry = new Directory({
              parent: self,
              name: name
            });
          } else {
            entry = self.folders[index];
            self.folders.splice(index, 1);
          }
          folders.push(entry);
        } else {
          if ((index = self.exists(name, false)) === null) {
            entry = new File({
              parent: self,
              name: name
            });
          } else {
            entry = self.files[index];
            self.files.splice(index, 1);
          }
          entry.size = item.size;
          entry.date = item.date;
          files.push(entry);
        }
      });

      self.folders.forEach(function (folder) {
        folder.destroy();
      });
      self.folders = folders;

      self.files.forEach(function (file) {
        file.destroy();
      });
      self.files = files;

      if (recursive) {
        self.folders.forEach(function (folder) {
          if (folder.status === 0) {
            return;
          }

          folder.open(true);
        });
      }

      if (typeof complete === 'function') {
        complete.call(null);
      }
    });
  };

  Directory.prototype.openPath = function (path) {
    var self = this,
        client = self.root.client;

    var remainingPath = path.replace(self.remote, '');
    if (remainingPath.startsWith('/')) {
      remainingPath = remainingPath.substr(1);
    }

    if (remainingPath.length > 0) {
      var remainingPathSplit = remainingPath.split('/');

      if (remainingPathSplit.length > 0 && self.folders.length > 0) {
        (function () {
          var nextPath = self.remote;

          if (!nextPath.endsWith('/')) {
            nextPath += '/';
          }

          nextPath += remainingPathSplit[0];

          self.folders.forEach(function (folder) {
            if (folder.remote === nextPath) {
              folder.isExpanded = true;

              if (folder.folders.length > 0) {
                folder.openPath(path);
              } else {
                folder.open(false, function () {
                  folder.openPath(path);
                });
              }

              return false;
            }
          });
        })();
      }
    }
  };

  return Directory;
})(Model);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImZpbGU6Ly8vQzovVXNlcnMvdWNoaWhhLy5hdG9tL3BhY2thZ2VzL1JlbW90ZS1GVFAvbGliL2RpcmVjdG9yeS5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxXQUFXLENBQUM7O0FBRVosSUFBSSxTQUFTLEdBQUcsQ0FBQSxHQUFFLENBQUMsY0FBYztJQUMvQixTQUFTLEdBQUcsU0FBWixTQUFTLENBQWEsS0FBSyxFQUFFLE1BQU0sRUFBRTtBQUFFLE9BQUssSUFBTSxHQUFHLElBQUksTUFBTSxFQUFFO0FBQUUsUUFBSSxTQUFTLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLENBQUMsRUFBRSxLQUFLLENBQUMsR0FBRyxDQUFDLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0dBQUUsQUFBQyxTQUFTLElBQUksR0FBRztBQUFFLFFBQUksQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFDO0dBQUUsQUFBQyxJQUFJLENBQUMsU0FBUyxHQUFHLE1BQU0sQ0FBQyxTQUFTLENBQUMsQUFBQyxLQUFLLENBQUMsU0FBUyxHQUFHLElBQUksSUFBSSxFQUFFLENBQUMsQUFBQyxLQUFLLENBQUMsU0FBUyxHQUFHLE1BQU0sQ0FBQyxTQUFTLENBQUMsQUFBQyxPQUFPLEtBQUssQ0FBQztDQUFFO0lBQ2xTLElBQUksR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDO0lBQ3RCLElBQUksR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDO0lBQ3hCLEtBQUssR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUMsS0FBSztJQUNqQyxvQkFBb0IsR0FBRyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUMsb0JBQW9CLENBQUM7O0FBR25FLE1BQU0sQ0FBQyxPQUFPLEdBQUcsU0FBUyxHQUFJLENBQUEsVUFBVSxNQUFNLEVBQUU7QUFDOUMsV0FBUyxDQUFDLFNBQVMsRUFBRSxNQUFNLENBQUMsQ0FBQzs7QUFFN0IsV0FBUyxDQUFDLFVBQVUsQ0FBQztBQUNuQixVQUFNLEVB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LENBQUMsT0FBTyxDQUFDLFVBQUMsTUFBTSxFQUFLO0FBQy9CLGdCQUFJLE1BQU0sQ0FBQyxNQUFNLEtBQUssUUFBUSxFQUFNO0FBQ2xDLG9CQUFNLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQzs7QUFFekIsa0JBQUksTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFPO0FBQ2xDLHNCQUFNLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO2VBQ3ZCLE1BQVc7QUFDVixzQkFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsWUFBTTtBQUN2Qix3QkFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztpQkFDdkIsQ0FBQyxDQUFDO2VBQ0o7O0FBRUQscUJBQU8sS0FBSyxDQUFDO2FBQ2Q7V0FDRixDQUFDLENBQUM7O09BQ0o7S0FDRjtHQUNGLENBQUM7O0FBRUYsU0FBTyxTQUFTLENBQUM7Q0FDbEIsQ0FBQSxDQUFDLEtBQUssQ0FBQyxBQUFDLENBQUMiLCJmaWxlIjoiZmlsZTovLy9DOi9Vc2Vycy91Y2hpaGEvLmF0b20vcGFja2FnZXMvUmVtb3RlLUZUUC9saWIvZGlyZWN0b3J5LmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBiYWJlbCc7XG5cbmxldCBfX2hhc1Byb3AgPSB7fS5oYXNPd25Qcm9wZXJ0eSxcbiAgX19leHRlbmRzID0gZnVuY3Rpb24gKGNoaWxkLCBwYXJlbnQpIHsgZm9yIChjb25zdCBrZXkgaW4gcGFyZW50KSB7IGlmIChfX2hhc1Byb3AuY2FsbChwYXJlbnQsIGtleSkpIGNoaWxkW2tleV0gPSBwYXJlbnRba2V5XTsgfSBmdW5jdGlvbiBjdG9yKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gY2hpbGQ7IH0gY3Rvci5wcm90b3R5cGUgPSBwYXJlbnQucHJvdG90eXBlOyBjaGlsZC5wcm90b3R5cGUgPSBuZXcgY3RvcigpOyBjaGlsZC5fX3N1cGVyX18gPSBwYXJlbnQucHJvdG90eXBlOyByZXR1cm4gY2hpbGQ7IH0sXG4gIHBhdGggPSByZXF1aXJlKCdwYXRoJyksXG4gIEZpbGUgPSByZXF1aXJlKCcuL2ZpbGUnKSxcbiAgTW9kZWwgPSByZXF1aXJlKCd0aGVvcmlzdCcpLk1vZGVsLFxuICBtdWx0aXBsZUhvc3RzRW5hYmxlZCA9IHJlcXVpcmUoJy4vaGVscGVycycpLm11bHRpcGxlSG9zdHNFbmFibGVkO1xuXG5cbm1vZHVsZS5leHBvcnRzID0gRGlyZWN0b3J5ID0gKGZ1bmN0aW9uIChwYXJlbnQpIHtcbiAgX19leHRlbmRzKERpcmVjdG9yeSwgcGFyZW50KTtcblxuICBEaXJlY3RvcnkucHJvcGVydGllcyh7XG4gICAgcGFyZW50OiBudWxsLFxuICAgIG5hbWU6ICcnLFxuICAgIHBhdGg6ICcnLFxuICAgIGNsaWVudDogbnVsbCxcbiAgICBpc0V4cGFuZGVkOiBmYWxzZSxcbiAgICBzdGF0dXM6IDAsXG4gICAgZm9sZGVyczogW10sXG4gICAgZmlsZXM6IFtdLFxuICB9KTtcblxuICBEaXJlY3RvcnkucHJvdG90eXBlLmFjY2Vzc29yKCdpc1Jvb3QnLCBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIHRoaXMucGFyZW50ID09PSBudWxsO1xuICB9KTtcblxuICBEaXJlY3RvcnkucHJvdG90eXBlLmFjY2Vzc29yKCdsb2NhbCcsIGZ1bmN0aW9uICgpIHtcbiAgICBpZiAodGhpcy5wYXJlbnQpIHJldHVybiBwYXRoLm5vcm1hbGl6ZShwYXRoLmpvaW4odGhpcy5wYXJlbnQubG9jYWwsIHRoaXMubmFtZSkpLnJlcGxhY2UoL1xcXFwvZywgJy8nKTtcblxuICAgIHJldHVybiBtdWx0aXBsZUhvc3RzRW5hYmxlZCgpID09PSB0cnVlID8gdGhpcy5jbGllbnQucHJvamVjdFBhdGggOiBhdG9tLnByb2plY3QuZ2V0UGF0aHMoKVswXTtcbiAgfSk7XG5cbiAgRGlyZWN0b3J5LnByb3RvdHlwZS5hY2Nlc3NvcigncmVtb3RlJywgZnVuY3Rpb24gKCkge1xuICAgIGlmICh0aGlzLnBhcmVudClcdFx0XHR7IHJldHVybiBwYXRoLm5vcm1hbGl6ZShwYXRoLmpvaW4odGhpcy5wYXJlbnQucmVtb3RlLCB0aGlzLm5hbWUpKS5yZXBsYWNlKC9cXFxcL2csICcvJyk7IH1cbiAgICByZXR1cm4gdGhpcy5wYXRoO1xuICB9KTtcblxuICBEaXJlY3RvcnkucHJvdG90eXBlLmFjY2Vzc29yKCdyb290JywgZnVuY3Rpb24gKCkge1xuICAgIGlmICh0aGlzLnBhcmVudClcdFx0XHR7IHJldHVybiB0aGlzLnBhcmVudC5yb290OyB9XG4gICAgcmV0dXJuIHRoaXM7XG4gIH0pO1xuXG4gIGZ1bmN0aW9uIERpcmVjdG9yeSgpIHtcbiAgICBEaXJlY3RvcnkuX19zdXBlcl9fLmNvbnN0cnVjdG9yLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XG4gIH1cblxuICBEaXJlY3RvcnkucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy5mb2xkZXJzLmZvckVhY2goKGZvbGRlcikgPT4ge1xuICAgICAgZm9sZGVyLmRlc3Ryb3koKTtcbiAgICB9KTtcbiAgICB0aGlzLmZvbGRlcnMgPSBbXTtcblxuICAgIHRoaXMuZmlsZXMuZm9yRWFjaCgoZmlsZSkgPT4ge1xuICAgICAgZmlsZS5kZXN0cm95KCk7XG4gICAgfSk7XG4gICAgdGhpcy5maWxlcyA9IFtdO1xuXG4gICAgaWYgKCF0aGlzLmlzUm9vdClcdFx0XHR7IERpcmVjdG9yeS5fX3N1cGVyX18uZGVzdHJveS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOyB9XG4gIH07XG5cbiAgRGlyZWN0b3J5LnByb3RvdHlwZS5zb3J0ID0gZnVuY3Rpb24gKCkge1xuICAgIHRoaXMuZm9sZGVycy5zb3J0KChhLCBiKSA9PiB7XG4gICAgICBpZiAoYS5uYW1lID09IGIubmFtZSlcdFx0XHRcdHsgcmV0dXJuIDA7IH1cbiAgICAgIHJldHVybiBhLm5hbWUgPiBiLm5hbWUgPyAxIDogLTE7XG4gICAgfSk7XG5cbiAgICB0aGlzLmZpbGVzLnNvcnQoKGEsIGIpID0+IHtcbiAgICAgIGlmIChhLm5hbWUgPT0gYi5uYW1lKVx0XHRcdFx0eyByZXR1cm4gMDsgfVxuICAgICAgcmV0dXJuIGEubmFtZSA+IGIubmFtZSA/IDEgOiAtMTtcbiAgICB9KTtcbiAgfTtcblxuICBEaXJlY3RvcnkucHJvdG90eXBlLmV4aXN0cyA9IGZ1bmN0aW9uIChuYW1lLCBpc2Rpcikge1xuICAgIGlmIChpc2Rpcikge1xuICAgICAgZm9yIChhID0gMCwgYiA9IHRoaXMuZm9sZGVycy5sZW5ndGg7IGEgPCBiOyArK2EpIHsgaWYgKHRoaXMuZm9sZGVyc1thXS5uYW1lID09IG5hbWUpXHRcdFx0XHRcdHsgcmV0dXJuIGE7IH0gfVxuICAgIH0gZWxzZSB7XG4gICAgICBmb3IgKGEgPSAwLCBiID0gdGhpcy5maWxlcy5sZW5ndGg7IGEgPCBiOyArK2EpIHtcbiAgICAgICAgaWYgKHRoaXMuZmlsZXNbYV0ubmFtZSA9PSBuYW1lKVx0XHRcdFx0XHR7IHJldHVybiBhOyB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBudWxsO1xuICB9O1xuXG4gIERpcmVjdG9yeS5wcm90b3R5cGUub3BlbiA9IGZ1bmN0aW9uIChyZWN1cnNpdmUsIGNvbXBsZXRlKSB7XG4gICAgbGV0IHNlbGYgPSB0aGlzLFxuICAgICAgY2xpZW50ID0gc2VsZi5yb290LmNsaWVudDtcblxuICAgIGNsaWVudC5saXN0KHNlbGYucmVtb3RlLCBmYWxzZSwgKGVyciwgbGlzdCkgPT4ge1xuICAgICAgaWYgKGVycikge1xuICAgICAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkRXJyb3IoYFJlbW90ZSBGVFA6ICR7ZXJyfWAsIHtcbiAgICAgICAgICBkaXNtaXNzYWJsZTogZmFsc2UsXG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cblxuICAgICAgc2VsZi5zdGF0dXMgPSAxO1xuXG4gICAgICBsZXQgZm9sZGVycyA9IFtdLFxuICAgICAgICBmaWxlcyA9IFtdO1xuXG4gICAgICBsaXN0LmZvckVhY2goKGl0ZW0pID0+IHtcbiAgICAgICAgbGV0IGluZGV4LFxuICAgICAgICAgIG5hbWUgPSBwYXRoLmJhc2VuYW1lKGl0ZW0ubmFtZSksXG4gICAgICAgICAgZW50cnk7XG4gICAgICAgIGlmIChpdGVtLnR5cGUgPT0gJ2QnIHx8IGl0ZW0udHlwZSA9PSAnbCcpIHtcbiAgICAgICAgICBpZiAobmFtZSA9PSAnLicgfHwgbmFtZSA9PSAnLi4nKVx0XHRcdFx0XHRcdHsgcmV0dXJuOyB9XG4gICAgICAgICAgaWYgKChpbmRleCA9IHNlbGYuZXhpc3RzKG5hbWUsIHRydWUpKSA9PT0gbnVsbCkge1xuICAgICAgICAgICAgZW50cnkgPSBuZXcgRGlyZWN0b3J5KHtcbiAgICAgICAgICAgICAgcGFyZW50OiBzZWxmLFxuICAgICAgICAgICAgICBuYW1lLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGVudHJ5ID0gc2VsZi5mb2xkZXJzW2luZGV4XTtcbiAgICAgICAgICAgIHNlbGYuZm9sZGVycy5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBmb2xkZXJzLnB1c2goZW50cnkpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGlmICgoaW5kZXggPSBzZWxmLmV4aXN0cyhuYW1lLCBmYWxzZSkpID09PSBudWxsKSB7XG4gICAgICAgICAgICBlbnRyeSA9IG5ldyBGaWxlKHtcbiAgICAgICAgICAgICAgcGFyZW50OiBzZWxmLFxuICAgICAgICAgICAgICBuYW1lLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGVudHJ5ID0gc2VsZi5maWxlc1tpbmRleF07XG4gICAgICAgICAgICBzZWxmLmZpbGVzLnNwbGljZShpbmRleCwgMSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGVudHJ5LnNpemUgPSBpdGVtLnNpemU7XG4gICAgICAgICAgZW50cnkuZGF0ZSA9IGl0ZW0uZGF0ZTtcbiAgICAgICAgICBmaWxlcy5wdXNoKGVudHJ5KTtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIHNlbGYuZm9sZGVycy5mb3JFYWNoKChmb2xkZXIpID0+IHsgZm9sZGVyLmRlc3Ryb3koKTsgfSk7XG4gICAgICBzZWxmLmZvbGRlcnMgPSBmb2xkZXJzO1xuXG4gICAgICBzZWxmLmZpbGVzLmZvckVhY2goKGZpbGUpID0+IHsgZmlsZS5kZXN0cm95KCk7IH0pO1xuICAgICAgc2VsZi5maWxlcyA9IGZpbGVzO1xuXG4gICAgICBpZiAocmVjdXJzaXZlKSB7XG4gICAgICAgIHNlbGYuZm9sZGVycy5mb3JFYWNoKChmb2xkZXIpID0+IHtcbiAgICAgICAgICBpZiAoZm9sZGVyLnN0YXR1cyA9PT0gMClcdFx0XHRcdFx0XHR7IHJldHVybjsgfVxuXG4gICAgICAgICAgZm9sZGVyLm9wZW4odHJ1ZSk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBpZiAodHlwZW9mIChjb21wbGV0ZSkgPT09ICdmdW5jdGlvbicpXHRcdFx0e1xuICAgICAgICBjb21wbGV0ZS5jYWxsKG51bGwpO1xuICAgICAgfVxuICAgIH0pO1xuICB9O1xuXG4gIERpcmVjdG9yeS5wcm90b3R5cGUub3BlblBhdGggPSBmdW5jdGlvbiAocGF0aCkge1xuICAgIGxldCBzZWxmID0gdGhpcyxcbiAgICAgIGNsaWVudCA9IHNlbGYucm9vdC5jbGllbnQ7XG5cbiAgICBsZXQgcmVtYWluaW5nUGF0aCA9IHBhdGgucmVwbGFjZShzZWxmLnJlbW90ZSwgJycpO1xuICAgIGlmIChyZW1haW5pbmdQYXRoLnN0YXJ0c1dpdGgoJy8nKSlcdFx0XHR7IHJlbWFpbmluZ1BhdGggPSByZW1haW5pbmdQYXRoLnN1YnN0cigxKTsgfVxuXG4gICAgaWYgKHJlbWFpbmluZ1BhdGgubGVuZ3RoID4gMClcdFx0e1xuICAgICAgY29uc3QgcmVtYWluaW5nUGF0aFNwbGl0ID0gcmVtYWluaW5nUGF0aC5zcGxpdCgnLycpO1xuXG4gICAgICBpZiAocmVtYWluaW5nUGF0aFNwbGl0Lmxlbmd0aCA+IDAgJiYgc2VsZi5mb2xkZXJzLmxlbmd0aCA+IDApXHRcdFx0e1xuICAgICAgICBsZXQgbmV4dFBhdGggPSBzZWxmLnJlbW90ZTtcblxuICAgICAgICBpZiAoIW5leHRQYXRoLmVuZHNXaXRoKCcvJykpXHRcdFx0XHRcdHsgbmV4dFBhdGggKz0gJy8nOyB9XG5cbiAgICAgICAgbmV4dFBhdGggKz0gcmVtYWluaW5nUGF0aFNwbGl0WzBdO1xuXG4gICAgICAgIHNlbGYuZm9sZGVycy5mb3JFYWNoKChmb2xkZXIpID0+IHtcbiAgICAgICAgICBpZiAoZm9sZGVyLnJlbW90ZSA9PT0gbmV4dFBhdGgpXHRcdFx0XHRcdHtcbiAgICAgICAgICAgIGZvbGRlci5pc0V4cGFuZGVkID0gdHJ1ZTtcblxuICAgICAgICAgICAgaWYgKGZvbGRlci5mb2xkZXJzLmxlbmd0aCA+IDApXHRcdFx0XHRcdFx0e1xuICAgICAgICAgICAgICBmb2xkZXIub3BlblBhdGgocGF0aCk7XG4gICAgICAgICAgICB9IGVsc2VcdFx0XHRcdFx0XHR7XG4gICAgICAgICAgICAgIGZvbGRlci5vcGVuKGZhbHNlLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgZm9sZGVyLm9wZW5QYXRoKHBhdGgpO1xuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuICB9O1xuXG4gIHJldHVybiBEaXJlY3Rvcnk7XG59KE1vZGVsKSk7XG4iXX0=